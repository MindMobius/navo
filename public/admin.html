<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navo - 管理中心</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/mustache@latest/mustache.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // 配置marked以支持GitHub风格的任务列表
        marked.setOptions({
            gfm: true,
            breaks: true
        });
    </script>
</head>
<body>
    <!-- 顶栏工具 -->
    <div class="top-toolbar">
        <div class="toolbar-branding">
            <div class="toolbar-title-container">
                <h1 class="toolbar-title">Navo</h1>
                <p class="toolbar-description">以用户评价为核心的轻量化导航站</p>
            </div>
        </div>
        <div class="admin-button-container">
            <a href="/" class="admin-btn" id="homeBtn" title="返回首页">
                <i data-feather="home"></i>
            </a>
            <a href="/key-auth.html" class="admin-btn" id="keyAuthBtn" title="密钥认证">
                <i data-feather="key"></i>
                <span class="key-status-indicator" id="keyStatusIndicator"></span>
            </a>
            <button class="admin-btn active" id="adminBtn" title="管理中心">
                <i data-feather="settings"></i>
            </button>
        </div>
    </div>

    <!-- 主要内容容器 -->
    <div class="main-content">
        <div class="container">
            <!-- 统计信息 -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon bg-blue">
                        <i data-feather="globe"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="siteCount">0</h3>
                        <p>站点总数</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-green">
                        <i data-feather="message-square"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="reviewCount">0</h3>
                        <p>评论总数</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-orange">
                        <i data-feather="folder"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="favCount">0</h3>
                        <p>收藏夹数</p>
                    </div>
                </div>
            </div>
            
            <!-- 顶部导航 -->
            <div class="admin-nav">
                <button class="admin-page-btn active" data-page="sites">
                    <i data-feather="globe"></i>
                    <span>站点管理</span>
                </button>
                <button class="admin-page-btn" data-page="reviews">
                    <i data-feather="message-square"></i>
                    <span>评论管理</span>
                </button>
                <button class="admin-page-btn" data-page="favorites">
                    <i data-feather="folder"></i>
                    <span>收藏夹管理</span>
                </button>
            </div>

            <!-- 主体内容 -->
            <main class="admin-main">
                <!-- 站点管理页面 -->
                <div class="admin-page active" id="sitesPage">
                    <div class="admin-page-header">
                        <h2>站点列表</h2>
                        <button id="addSiteBtn" class="btn btn-primary">
                            <i data-feather="plus"></i>
                            添加站点
                        </button>
                    </div>
                    
                    <div class="admin-section">
                        <div class="items-grid" id="adminSiteGrid">
                            <!-- 站点列表将通过JavaScript动态加载 -->
                            <div class="empty-state">
                                <i data-feather="globe" class="empty-icon"></i>
                                <p>暂无站点数据</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 评论管理页面 -->
                <div class="admin-page" id="reviewsPage">
                    <div class="admin-page-header">
                        <h2>评论列表</h2>
                    </div>
                    
                    <div class="admin-section">
                        <div class="items-grid" id="reviewsGrid">
                            <!-- 评论列表将通过JavaScript动态加载 -->
                            <div class="empty-state">
                                <i data-feather="message-square" class="empty-icon"></i>
                                <p>暂无评论数据</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 收藏夹管理页面 -->
                <div class="admin-page" id="favoritesPage">
                    <div class="admin-page-header">
                        <h2>收藏夹列表</h2>
                        <button id="addFavBtn" class="btn btn-primary" style="display: none;">
                            <i data-feather="plus"></i>
                            新建收藏夹
                        </button>
                    </div>
                    
                    <div class="admin-section">
                        <div class="info-box">
                            <h3>使用说明</h3>
                            <p>收藏夹创建后，用户可以通过 <code>/fav-别名</code> 的方式直接访问。</p>
                            <p>例如：别名为 <code>design-tools</code> 的收藏夹，访问地址为 <code>/fav-design-tools</code></p>
                            <div class="alert alert-warning">
                                <p><strong>功能开发中：</strong>收藏夹功能暂未完成开发，敬请期待。</p>
                            </div>
                        </div>
                        
                        <div class="items-grid" id="favoritesGrid">
                            <!-- 收藏夹列表将通过JavaScript动态加载 -->
                            <div class="empty-state">
                                <i data-feather="folder" class="empty-icon"></i>
                                <p>暂无收藏夹数据</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <footer class="site-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-links">
                        <span class="footer-item">项目支持：<a href="https://github.com/MindMobius" target="_blank" class="github-link"><i
                                    data-feather="github"></i> MindMobius</a></span>
                        <span class="footer-item">仓库地址：<a href="https://github.com/MindMobius/navo" target="_blank" class="github-link"><i
                                    data-feather="github"></i> navo</a></span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- 添加/编辑站点模态框 -->
    <div class="modal" id="siteModal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="siteModalTitle">添加站点</h2>
                <button class="modal-close" id="closeSiteModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="siteForm">
                    <input type="hidden" id="siteId">
                    <div class="form-group">
                        <label for="siteName">站点名称</label>
                        <input type="text" id="siteName" required placeholder="请输入站点名称">
                    </div>
                    <div class="form-group">
                        <label for="siteUrl">站点URL</label>
                        <input type="url" id="siteUrl" required placeholder="请输入站点URL">
                    </div>
                    <div class="form-group">
                        <label for="siteStatus">状态</label>
                        <select id="siteStatus" required>
                            <option value="actived">已激活</option>
                            <option value="deleted">已删除</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelSiteBtn">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加/编辑评论模态框 -->
    <div class="modal" id="reviewModal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="reviewModalTitle">添加评论</h2>
                <button class="modal-close" id="closeReviewModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    <input type="hidden" id="reviewId">
                    <div class="form-group">
                        <label for="reviewContent">评论内容</label>
                        <div class="tab-container">
                            <div class="tab active" data-tab="edit">编辑</div>
                            <div class="tab" data-tab="preview">预览</div>
                        </div>
                        <div class="tab-content active" id="editTab">
                            <textarea id="reviewEditor" placeholder="在此编辑你的评论内容 (支持 Markdown 语法)" style="resize: none;"></textarea>
                        </div>
                        <div class="tab-content" id="previewTab">
                            <div class="preview-container" id="reviewPreview" style="overflow-y: auto;"></div>
                        </div>
                        <textarea id="reviewContent" required placeholder="请输入评论内容，支持Markdown语法" style="display: none;"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelReviewBtn">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 评论详情模态框 -->
    <div class="modal" id="reviewDetailModal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2>站点详情</h2>
                <button class="modal-close" id="closeReviewDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-info">
                    <div class="form-group">
                        <label>SUID</label>
                        <div id="detailSuid"></div>
                    </div>
                    <div class="form-group">
                        <label>站点名称</label>
                        <div id="detailName"></div>
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <div id="detailUrl"></div>
                    </div>
                    <div class="form-group">
                        <label>图标</label>
                        <div id="detailIcon"></div>
                    </div>
                    <div class="form-group">
                        <label>状态</label>
                        <div id="detailStatus"></div>
                    </div>
                    <div class="form-group">
                        <label>创建时间</label>
                        <div id="detailCreatedAt"></div>
                    </div>
                    <div class="form-group">
                        <label>更新时间</label>
                        <div id="detailUpdatedAt"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="closeReviewDetailBtn">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建/编辑收藏夹模态框 -->
    <div class="modal" id="favModal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="favModalTitle">新建收藏夹</h2>
                <button class="modal-close" id="closeFavModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="favForm">
                    <input type="hidden" id="favId">
                    <div class="form-group">
                        <label for="favName">收藏夹名称</label>
                        <input type="text" id="favName" required placeholder="请输入收藏夹名称">
                    </div>
                    <div class="form-group">
                        <label for="favSlug">别名 (用于URL，仅限英文，20字符以内)</label>
                        <input type="text" id="favSlug" required placeholder="例如: design-tools" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="favDescription">描述（可选）</label>
                        <textarea id="favDescription" placeholder="请输入收藏夹描述"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelFavBtn">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 收藏夹详情模态框 -->
    <div class="modal" id="favDetailModal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="favDetailTitle">收藏夹详情</h2>
                <button class="modal-close" id="closeFavDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="fav-detail-info">
                    <p id="favDetailDescription"></p>
                </div>
                
                <div class="form-group">
                    <label>添加站点到收藏夹</label>
                    <div class="search-box" style="margin-bottom: 10px;">
                        <input type="text" id="siteSearchInput" placeholder="搜索站点名称或URL">
                    </div>
                    <div class="site-list" id="siteList">
                        <!-- 站点列表将通过JavaScript动态加载 -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>已收藏站点</label>
                    <div class="site-list" id="favSiteList">
                        <!-- 已收藏站点列表将通过JavaScript动态加载 -->
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" id="backToFavList">返回</button>
                    <button class="btn btn-danger" id="deleteFavBtn">删除收藏夹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mustache 模板 -->
    <script id="site-card-template" type="text/template">
        {{#sites}}
        <div class="item-card">
            <div class="item-card-content">
                <div class="item-info">
                    <h3 class="item-title truncate-text">{{name}}</h3>
                    <p class="item-url truncate-text"><a href="{{url}}" target="_blank">{{url}}</a></p>
                    <div class="item-meta">
                        <div class="meta-item">
                            <span class="meta-label">SUID:</span>
                            <span class="meta-value copyable-suid" data-suid="{{suid}}" title="点击复制">{{suid}}</span>
                        </div>
                    </div>
                    <div class="item-meta secondary-meta">
                        <div class="meta-item meta-secondary">
                            <span class="meta-label">创建:</span>
                            <span class="meta-value">{{created_at}}</span>
                        </div>
                        <div class="meta-item meta-secondary">
                            <span class="meta-label">更新:</span>
                            <span class="meta-value">{{updated_at}}</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="item-status status-{{status}}">
                        <span class="status-indicator {{status}}"></span>
                        {{#statusEquals}}
                        {{#actived}}已激活{{/actived}}
                        {{#deleted}}已删除{{/deleted}}
                        {{/statusEquals}}
                    </div>
                    <div class="item-actions">
                        <button class="icon-button edit-btn" onclick="editSite('{{suid}}')" title="编辑">
                            <i data-feather="edit"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {{/sites}}
        {{^sites}}
        <div class="empty-state">
            <i data-feather="globe" class="empty-icon"></i>
            <p>暂无站点数据</p>
        </div>
        {{/sites}}
    </script>

    <script id="review-card-template" type="text/template">
        {{#reviews}}
        <div class="item-card">
            <div class="item-card-content">
                <div class="item-info">
                    <div class="item-content markdown-content" id="review-content-{{id}}">{{{content}}}</div>
                </div>
                    <div class="review-meta">
                        <div class="meta-item meta-secondary">
                            <span class="meta-label">创建:</span>
                            <span class="meta-value">{{created_at}}</span>
                        </div>
                        <div class="meta-item meta-secondary">
                            <span class="meta-label">更新:</span>
                            <span class="meta-value">{{updated_at}}</span>
                        </div>
                    </div>
                <div class="item-actions">
                    <button class="icon-button detail-btn" onclick="showReviewDetail('{{suid}}')" title="详情">
                        <i data-feather="info"></i>
                    </button>
                    <button class="icon-button edit-btn" onclick="editReview('{{id}}')" title="编辑">
                        <i data-feather="edit"></i>
                    </button>
                    <button class="icon-button delete-btn" onclick="deleteReview('{{id}}')" title="删除">
                        <i data-feather="trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {{/reviews}}
        {{^reviews}}
        <div class="empty-state">
            <i data-feather="message-square" class="empty-icon"></i>
            <p>暂无评论数据</p>
        </div>
        {{/reviews}}
    </script>

    <script src="/js/admin.js"></script>
    <script>
        // 初始化 feather icons
        feather.replace();
        
        // 页面切换功能
        document.addEventListener('DOMContentLoaded', function() {
            // 检查密钥
            checkApiKey();
            
            const pageButtons = document.querySelectorAll('.admin-page-btn');
            const pages = document.querySelectorAll('.admin-page');
            
            pageButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    
                    // 更新按钮状态
                    pageButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 显示对应页面
                    pages.forEach(p => p.classList.remove('active'));
                    document.getElementById(page + 'Page').classList.add('active');
                    
                    // 当切换到收藏夹页面时，渲染收藏夹列表
                    if (page === 'favorites') {
                        renderFavorites();
                    }
                    
                    // 当切换到站点页面时，渲染站点列表
                    if (page === 'sites') {
                        renderSites();
                    }
                    
                    // 当切换到评论页面时，渲染评论列表
                    if (page === 'reviews') {
                        renderReviews();
                    }
                });
            });
            
            // 初始化渲染
            renderSites();
            renderReviews();
            renderFavorites();
            updateStats();
        });
        
        // 检查API密钥
        function checkApiKey() {
            const apiKey = localStorage.getItem('navo_api_key');
            
            // 检查密钥格式: navo- + 46个小写字母，总共51个字符
            if (!apiKey || !/^navo-[a-z]{46}$/.test(apiKey)) {
                // 创建提示说明元素
                const noKeyMessage = document.createElement('div');
                noKeyMessage.className = 'no-api-key-message';
                noKeyMessage.innerHTML = `
                    <div class="no-api-key-content">
                        <h3>需要API密钥才能访问管理中心</h3>
                        <p>Navo采用无用户系统设计</p>
                        <p>通过您创建的API密钥来识别和授权数据访问权限</p>
                        <p>所有数据操作都需要对应的Navo密钥才能执行</p>
                        <p>请前往密钥管理页面生成并设置您的Navo密钥</p>
                        <button id="goToKeyAuth" class="btn btn-primary">前往设置密钥</button>
                    </div>
                `;
                
                // 查找并替换主要内容
                const mainContent = document.querySelector('.main-content .container');
                if (mainContent) {
                    // 清空内容并添加提示
                    mainContent.innerHTML = '';
                    mainContent.appendChild(noKeyMessage);
                    
                    // 添加跳转按钮事件
                    document.getElementById('goToKeyAuth').addEventListener('click', function() {
                        window.location.href = '/key-auth.html';
                    });
                }
                
                return false;
            }
            
            return true;
        }
        
        // 获取当前API密钥
        function getCurrentApiKey() {
            return localStorage.getItem('navo_api_key');
        }
        
        // 站点数据
        let sitesData = [];
        
        // 评论数据
        let reviewsData = [];
        
        // 更新统计数据
        function updateStats() {
            document.getElementById('siteCount').textContent = sitesData.length;
            document.getElementById('reviewCount').textContent = reviewsData.length;
            document.getElementById('favCount').textContent = 0; // 收藏夹功能暂未完成
        }
        
        // 渲染站点列表
        async function renderSites() {
            if (!checkApiKey()) return;
            
            const siteGrid = document.getElementById('adminSiteGrid');
            
            try {
                const response = await fetch('/api/sites/token', {
                    headers: {
                        'Authorization': `Bearer ${getCurrentApiKey()}`
                    }
                });
                
                if (response.ok) {
                    sitesData = await response.json();
                    
                    const template = document.getElementById('site-card-template').innerHTML;
                    const rendered = Mustache.render(template, {
                        sites: sitesData,
                        statusEquals: function() {
                            return {
                                actived: this.status === 'actived',
                                deleted: this.status === 'deleted'
                            };
                        }
                    });
                    
                    siteGrid.innerHTML = rendered;
                    
                    // 添加SUID复制功能
                    document.querySelectorAll('.copyable-suid').forEach(element => {
                        element.addEventListener('click', function() {
                            const suid = this.getAttribute('data-suid');
                            navigator.clipboard.writeText(suid).then(() => {
                                // 显示复制成功的提示
                                const originalText = this.textContent;
                                this.textContent = '已复制!';
                                setTimeout(() => {
                                    this.textContent = originalText;
                                }, 1000);
                            });
                        });
                    });
                    
                    feather.replace();
                } else {
                    siteGrid.innerHTML = `
                        <div class="empty-state">
                            <i data-feather="alert-triangle" class="empty-icon"></i>
                            <p>加载站点数据失败</p>
                        </div>
                    `;
                    feather.replace();
                }
            } catch (error) {
                siteGrid.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="alert-triangle" class="empty-icon"></i>
                        <p>加载站点数据时发生错误</p>
                    </div>
                `;
                feather.replace();
            }
            
            updateStats();
        }
        
        // 渲染评论列表
        async function renderReviews() {
            if (!checkApiKey()) return;
            
            const reviewsGrid = document.getElementById('reviewsGrid');
            
            try {
                const response = await fetch('/api/reviews/token', {
                    headers: {
                        'Authorization': `Bearer ${getCurrentApiKey()}`
                    }
                });
                
                if (response.ok) {
                    reviewsData = await response.json();
                    
                    const template = document.getElementById('review-card-template').innerHTML;
                    const rendered = Mustache.render(template, { reviews: reviewsData });
                    
                    reviewsGrid.innerHTML = rendered;
                    
                    // 渲染Markdown内容
                    document.querySelectorAll('.markdown-content').forEach(element => {
                        element.innerHTML = marked.parse(element.textContent || element.innerText);
                    });
                    
                    feather.replace();
                } else {
                    reviewsGrid.innerHTML = `
                        <div class="empty-state">
                            <i data-feather="alert-triangle" class="empty-icon"></i>
                            <p>加载评论数据失败</p>
                        </div>
                    `;
                    feather.replace();
                }
            } catch (error) {
                reviewsGrid.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="alert-triangle" class="empty-icon"></i>
                        <p>加载评论数据时发生错误</p>
                    </div>
                `;
                feather.replace();
            }
            
            updateStats();
        }
        
        // 渲染收藏夹列表
        function renderFavorites() {
            // 收藏夹功能暂未完成开发
            const favoritesGrid = document.getElementById('favoritesGrid');
            favoritesGrid.innerHTML = `
                <div class="empty-state">
                    <i data-feather="folder" class="empty-icon"></i>
                    <p>收藏夹功能开发中，敬请期待</p>
                </div>
            `;
            feather.replace();
            updateStats();
        }
        
        // 编辑站点
        async function editSite(siteSuid) {
            if (!checkApiKey()) return;
            
            try {
                const response = await fetch(`/api/sites/${siteSuid}`, {
                    headers: {
                        'Authorization': `Bearer ${getCurrentApiKey()}`
                    }
                });
                
                if (response.ok) {
                    const site = await response.json();
                    
                    // 填充表单
                    document.getElementById('siteId').value = site.suid;
                    document.getElementById('siteName').value = site.name;
                    document.getElementById('siteUrl').value = site.url;
                    document.getElementById('siteStatus').value = site.status;
                    
                    document.getElementById('siteModalTitle').textContent = '编辑站点';
                    document.getElementById('siteModal').classList.add('show');
                } else {
                    const errorData = await response.json();
                    alert('获取站点信息失败: ' + errorData.error);
                }
            } catch (error) {
                alert('获取站点信息时发生错误: ' + error.message);
            }
        }
        
        // 显示评论详情
        async function showReviewDetail(suid) {
            if (!checkApiKey()) return;
            
            try {
                const response = await fetch(`/api/sites/${suid}`, {
                    headers: {
                        'Authorization': `Bearer ${getCurrentApiKey()}`
                    }
                });
                
                if (response.ok) {
                    const site = await response.json();
                    
                    // 填充详情
                    document.getElementById('detailSuid').textContent = site.suid;
                    document.getElementById('detailName').textContent = site.name;
                    document.getElementById('detailUrl').textContent = site.url;
                    document.getElementById('detailIcon').textContent = site.icon || '无';
                    document.getElementById('detailStatus').textContent = site.status;
                    document.getElementById('detailCreatedAt').textContent = site.created_at;
                    document.getElementById('detailUpdatedAt').textContent = site.updated_at;
                    
                    document.getElementById('reviewDetailModal').classList.add('show');
                    feather.replace();
                } else {
                    const errorData = await response.json();
                    alert('获取站点详情失败: ' + errorData.error);
                }
            } catch (error) {
                alert('获取站点详情时发生错误: ' + error.message);
            }
        }
        
        // 编辑评论
        async function editReview(reviewId) {
            if (!checkApiKey()) return;
            
            try {
                // 查找评论
                const review = reviewsData.find(r => r.id == reviewId);
                if (!review) {
                    alert('未找到该评论');
                    return;
                }
                
                // 填充表单
                document.getElementById('reviewId').value = review.id;
                document.getElementById('reviewContent').value = review.content;
                
                // 同步到编辑器
                document.getElementById('reviewEditor').value = review.content;
                
                document.getElementById('reviewModalTitle').textContent = '编辑评论';
                document.getElementById('reviewModal').classList.add('show');
                
                // 初始化标签页状态为编辑状态
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('.tab[data-tab="edit"]').classList.add('active');
                document.getElementById('editTab').classList.add('active');
            } catch (error) {
                alert('编辑评论时发生错误');
            }
        }
        
        // 删除评论
        async function deleteReview(reviewId) {
            if (!checkApiKey()) return;
            
            if (!confirm('确定要删除这条评论吗？删除后将无法恢复！')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/reviews/${reviewId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getCurrentApiKey()}`
                    }
                });
                
                if (response.ok) {
                    alert('评论删除成功');
                    renderReviews(); // 重新加载评论列表
                } else {
                    const result = await response.json();
                    alert('删除评论失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                alert('删除评论时发生错误');
            }
        }
        
        // 显示新建收藏夹模态框
        document.getElementById('addFavBtn').addEventListener('click', function() {
            document.getElementById('favModalTitle').textContent = '新建收藏夹';
            document.getElementById('favId').value = '';
            document.getElementById('favName').value = '';
            document.getElementById('favSlug').value = '';
            document.getElementById('favDescription').value = '';
            document.getElementById('favModal').classList.add('show');
        });
        
        // 关闭模态框
        document.getElementById('closeFavModal').addEventListener('click', function() {
            document.getElementById('favModal').classList.remove('show');
        });
        
        document.getElementById('closeFavDetailModal').addEventListener('click', function() {
            document.getElementById('favDetailModal').classList.remove('show');
        });
        
        document.getElementById('cancelFavBtn').addEventListener('click', function() {
            document.getElementById('favModal').classList.remove('show');
        });
        
        document.getElementById('backToFavList').addEventListener('click', function() {
            document.getElementById('favDetailModal').classList.remove('show');
        });
        
        // 关闭评论详情模态框
        document.getElementById('closeReviewDetailModal').addEventListener('click', function() {
            document.getElementById('reviewDetailModal').classList.remove('show');
        });
        
        document.getElementById('closeReviewDetailBtn').addEventListener('click', function() {
            document.getElementById('reviewDetailModal').classList.remove('show');
        });
        
        // 表单提交事件
        document.getElementById('favForm').addEventListener('submit', function(e) {
            e.preventDefault();
            // 这里应该添加保存逻辑
            const id = document.getElementById('favId').value;
            const name = document.getElementById('favName').value;
            const slug = document.getElementById('favSlug').value;
            const description = document.getElementById('favDescription').value;
            
            if (id) {
                // 编辑现有收藏夹
                // 实现逻辑
            } else {
                // 添加新收藏夹
                // 实现逻辑
            }
            
            document.getElementById('favModal').classList.remove('show');
            renderFavorites(); // 重新渲染
        });
        
        // 站点管理按钮事件
        document.getElementById('addSiteBtn').addEventListener('click', function() {
            // 清空表单
            document.getElementById('siteId').value = '';
            document.getElementById('siteName').value = '';
            document.getElementById('siteUrl').value = '';
            document.getElementById('siteStatus').value = 'actived';
            
            document.getElementById('siteModal').classList.add('show');
            document.getElementById('siteModalTitle').textContent = '添加站点';
        });
        
        document.getElementById('closeSiteModal').addEventListener('click', function() {
            document.getElementById('siteModal').classList.remove('show');
        });
        
        document.getElementById('cancelSiteBtn').addEventListener('click', function() {
            document.getElementById('siteModal').classList.remove('show');
        });
        
        // 站点表单提交事件
        document.getElementById('siteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!checkApiKey()) return;
            
            const suid = document.getElementById('siteId').value;
            const name = document.getElementById('siteName').value;
            const url = document.getElementById('siteUrl').value;
            const status = document.getElementById('siteStatus').value;
            
            try {
                let response;
                if (suid) {
                    // 更新站点
                    response = await fetch(`/api/sites/${suid}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getCurrentApiKey()}`
                        },
                        body: JSON.stringify({ name, url, status })
                    });
                } else {
                    // 创建站点
                    response = await fetch('/api/sites', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getCurrentApiKey()}`
                        },
                        body: JSON.stringify({ name, url })
                    });
                }
                
                if (response.ok) {
                    document.getElementById('siteModal').classList.remove('show');
                    alert('操作成功');
                    renderSites(); // 重新加载站点列表
                } else {
                    const result = await response.json();
                    alert('操作失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                alert('操作时发生错误: ' + error.message);
            }
        });
        
        // 评论表单提交事件
        document.getElementById('reviewForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!checkApiKey()) return;
            
            const id = document.getElementById('reviewId').value;
            const content = document.getElementById('reviewContent').value;
            
            try {
                let response;
                if (id) {
                    // 更新评论
                    response = await fetch(`/api/reviews/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getCurrentApiKey()}`
                        },
                        body: JSON.stringify({ content })
                    });
                } else {
                    // 创建评论（这种情况不会发生，因为我们移除了添加评论按钮）
                    response = await fetch('/api/reviews', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getCurrentApiKey()}`
                        },
                        body: JSON.stringify({ content })
                    });
                }
                
                if (response.ok) {
                    document.getElementById('reviewModal').classList.remove('show');
                    alert('操作成功');
                    renderReviews(); // 重新加载评论列表
                } else {
                    const result = await response.json();
                    alert('操作失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                alert('操作时发生错误');
            }
        });
        
        // 评论编辑中的标签页切换功能
        document.addEventListener('click', function(e) {
            // 检查点击的是否是标签
            if (e.target.classList.contains('tab')) {
                const tab = e.target;
                const tabContainer = tab.closest('.tab-container');
                
                // 确保这是评论模态框中的标签
                if (tabContainer && tabContainer.closest('#reviewModal')) {
                    const modal = tab.closest('.modal');
                    
                    // 移除同容器内所有标签的活动状态
                    tabContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    modal.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加活动状态到当前标签和对应内容
                    tab.classList.add('active');
                    const tabName = tab.getAttribute('data-tab');
                    const contentDiv = modal.querySelector(`#${tabName}Tab`);
                    if (contentDiv) {
                        contentDiv.classList.add('active');
                    }
                    
                    // 如果是预览标签，渲染Markdown
                    if (tabName === 'preview') {
                        const editor = modal.querySelector('#reviewEditor');
                        const preview = modal.querySelector('#reviewPreview');
                        if (editor && preview) {
                            // 解析并渲染Markdown内容
                            preview.innerHTML = marked.parse(editor.value);
                            
                            // 确保内容不超出容器范围
                            preview.querySelectorAll('*').forEach(element => {
                                element.style.maxWidth = '100%';
                                element.style.boxSizing = 'border-box';
                            });
                        }
                    }
                }
            }
        });
        
        // 在评论编辑器输入时实时更新内容同步
        document.addEventListener('input', function(e) {
            if (e.target.id === 'reviewEditor') {
                const editor = e.target;
                // 同步到隐藏的表单字段
                document.getElementById('reviewContent').value = editor.value;
                
                // 如果预览标签处于激活状态，则实时更新预览
                const previewTab = document.querySelector('.tab[data-tab="preview"]');
                if (previewTab && previewTab.classList.contains('active')) {
                    const preview = document.getElementById('reviewPreview');
                    if (preview) {
                        // 解析并渲染Markdown内容
                        preview.innerHTML = marked.parse(editor.value);
                    }
                }
            }
        });
        
        // 模态框外部点击关闭
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function() {
                this.parentElement.classList.remove('show');
            });
        });
        
        // 修复评论编辑模态框的关闭按钮
        document.getElementById('closeReviewModal').addEventListener('click', function() {
            document.getElementById('reviewModal').classList.remove('show');
        });
        
        document.getElementById('cancelReviewBtn').addEventListener('click', function() {
            document.getElementById('reviewModal').classList.remove('show');
        });
    </script>
</body>
</html>